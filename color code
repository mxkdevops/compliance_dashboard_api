


# --------------------- Minimal UI (same one-page dashboard) ---------------------
INDEX_HTML = r"""
<!doctype html><html><head><meta charset="utf-8"/><title>Compliance Dashboard (FastAPI)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
:root{--blue:#0f4c81;--green:#27ae60;--amber:#f39c12;--red:#e74c3c;--bg:#f7f9fc;--ink:#2c3e50;--card:#fff;--muted:#8aa0b4}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
header{background:var(--blue);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
header h1{margin:0;font-size:18px;letter-spacing:.5px}
.summary{display:flex;gap:12px;flex-wrap:wrap}
.tile{background:#ffffff1a;padding:8px 12px;border-radius:10px;font-size:13px}
.wrap{display:grid;grid-template-columns:1fr 380px;gap:14px;padding:14px}
.filters{display:flex;gap:8px;align-items:center;margin:4px 0 10px}
input,select,button{font:inherit;padding:8px 10px;border:1px solid #dfe7ef;border-radius:10px;outline:none}
button{background:var(--blue);color:#fff;border:none;cursor:pointer}
button.ghost{background:#fff;color:var(--blue);border:1px solid var(--blue)}
.board{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:var(--card);border-radius:14px;padding:12px;border:2px solid #e8eef5;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.card.ok{border-color:var(--green)}.card.due_soon{border-color:var(--amber)}.card.due{border-color:var(--red)}
.card h3{margin:0 0 4px;font-size:16px}.meta{font-size:12px;color:var(--muted)}
.side{background:var(--card);border-radius:14px;padding:12px;border:2px solid #e8eef5;height:calc(100vh - 110px);overflow:auto}
.ppm{border-bottom:1px solid #eef3f8;padding:8px 0}.ppm:last-child{border-bottom:none}
.ppm .title{font-weight:600}.status-pill{display:inline-block;padding:2px 8px;font-size:11px;border-radius:999px;margin-left:8px}
.pill-ok{background:var(--green);color:#fff}.pill-soon{background:var(--amber);color:#fff}.pill-due{background:var(--red);color:#fff}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.row label{font-size:12px;color:var(--muted)}.ppm small{color:var(--muted)}.edit{display:flex;gap:6px;margin-top:6px}
</style></head><body>
<header><h1>Compliance Dashboard (FastAPI)</h1><div class="summary" id="summary"></div></header>
<div class="wrap"><div>
  <div class="filters">
    <input id="q" placeholder="Search site name / code / UPRN"/>
    <select id="status"><option value="">All statuses</option><option>Active</option><option>Closed</option><option>Suspended</option><option>Under-Construction</option><option>Unknown</option></select>
    <button onclick="loadSites()">Search</button>
  </div>
  <div class="board" id="board"></div>
</div>
<aside class="side">
  <h3 id="sideTitle">Select a site</h3>
  <div class="row" style="margin-bottom:8px">
    <label>Site status:</label>
    <select id="siteStatus" disabled onchange="saveSiteStatus()">
      <option>Active</option><option>Closed</option><option>Suspended</option><option>Under-Construction</option><option>Unknown</option>
    </select>
    <button class="ghost" onclick="toggleInactive()" id="toggleInactive" style="display:none">Show inactive PPM</button>
  </div>
  <div id="ppmList"></div>
</aside></div>
<script>
let currentSite=null, includeInactive=0;
function pill(l){if(l==='DUE')return'<span class="status-pill pill-due">DUE</span>';if(l==='DUE_SOON')return'<span class="status-pill pill-soon">DUE SOON</span>';return'<span class="status-pill pill-ok">OK</span>'}
async function loadSummary(){const r=await fetch('/api/summary');const d=await r.json();document.getElementById('summary').innerHTML=
`<div class="tile">Sites: <b>${d.total_sites}</b></div>
<div class="tile">Active Sites: <b>${d.active_sites}</b></div>
<div class="tile">Active PPM: <b>${d.total_ppm_active}</b></div>
<div class="tile">Overdue: <b>${d.overdue}</b></div>
<div class="tile">Due next 30d: <b>${d.due_next_30}</b></div>
<div class="tile">Compliant Sites: <b>${d.compliant_sites}</b></div>
<div class="tile">Non-Compliant Sites: <b>${d.non_compliant_sites}</b></div>`}
async function loadSites(){const q=document.getElementById('q').value.trim();const s=document.getElementById('status').value;const params=new URLSearchParams({limit:50});if(q)params.set('q',q);if(s)params.set('status',s);const r=await fetch('/api/sites?'+params.toString());const rows=await r.json();document.getElementById('board').innerHTML=rows.map(x=>{const cls=x.ui_status==='DUE'?'due':(x.ui_status==='DUE_SOON'?'due_soon':'ok');return`<div class="card ${cls}" onclick='selectSite(${JSON.stringify(x)})'><h3>${x.name||'(no name)'} ${pill(x.ui_status)}</h3><div class="meta">UPRN: ${x.uprn||'-'} • Code: ${x.site_code||'-'} • Active PPM: ${x.active_ppm}</div><div class="meta">Min Next Due: ${x.min_next_due||'—'}</div></div>`}).join('')}
async function selectSite(site){currentSite=site;includeInactive=0;document.getElementById('sideTitle').textContent=site.name||'(no name)';const sel=document.getElementById('siteStatus');sel.value=site.status;sel.disabled=false;document.getElementById('toggleInactive').style.display='inline-block';await loadPPM()}
async function toggleInactive(){includeInactive=includeInactive?0:1;await loadPPM()}
function fmtRow(p){return `<div class="ppm"><div class="title">${p.category_name||'-'} — ${p.instruction||'(no instruction)'}</div><small>Next due: ${p.next_due_date||'—'} • Freq: ${p.frequency_months||'—'} • Active: ${p.is_active?'Yes':'No'}</small><div class="edit"><input type="date" value="${p.next_due_date||''}" onchange="queueUpdate(${p.ppm_plan_id}, 'next_due_date', this.value)"/><input type="date" placeholder="suspend until" value="${p.suspended_until||''}" onchange="queueUpdate(${p.ppm_plan_id}, 'suspended_until', this.value)"/><select onchange="queueUpdate(${p.ppm_plan_id}, 'is_active', this.value)"><option value="1" ${p.is_active?'selected':''}>Active</option><option value="0" ${!p.is_active?'selected':''}>Inactive</option></select><input placeholder="retired reason" value="${p.retired_reason||''}" onchange="queueUpdate(${p.ppm_plan_id}, 'retired_reason', this.value)"/><button onclick="saveUpdate(${p.ppm_plan_id})">Save</button></div></div>`}
const pending=new Map();function queueUpdate(id,key,val){const obj=pending.get(id)||{};if(key==='is_active')obj[key]=(val==='1');else obj[key]=val||null;pending.set(id,obj)}
async function saveUpdate(id){const body=pending.get(id);if(!body){alert('Nothing to save');return}const r=await fetch('/api/ppm/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!r.ok){alert('Save failed');return}pending.delete(id);await loadPPM();await loadSummary()}
async function loadPPM(){if(!currentSite)return;const params=new URLSearchParams({site_id:currentSite.site_id});if(includeInactive)params.set('include_inactive','1');const r=await fetch('/api/ppm?'+params.toString());const rows=await r.json();document.getElementById('ppmList').innerHTML=rows.map(fmtRow).join('')||'<div class="meta">No PPM lines</div>'}
async function saveSiteStatus(){if(!currentSite)return;const newStatus=document.getElementById('siteStatus').value;await fetch('/api/site/'+currentSite.site_id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:newStatus})});await loadSummary();await loadSites()}
(async function init(){await loadSummary();await loadSites()})();
</script></body></html>
"""
